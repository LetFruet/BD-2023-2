-- 1 
CREATE TABLE USUARIO (
	cd_usuario INTEGER PRIMARY KEY,
	nm_usuario VARCHAR(50),
	ds_email VARCHAR(50),
	nr_telefone VARCHAR(15)
);
	
CREATE TABLE SERVICO (
	cd_servico INTEGER PRIMARY KEY,
	ds_servico VARCHAR(50),
	ds_sugestao VARCHAR(200)
);

CREATE TABLE SITUACAO (
	cd_situacao INTEGER PRIMARY KEY,
	ds_situacao VARCHAR(50)
);

CREATE TABLE ORDEM_SERVICO (
	nr_os INTEGER PRIMARY KEY,
	cd_usuario INTEGER,
	dt_registro DATE,
	ds_observacao VARCHAR(200),
	FOREIGN KEY (cd_usuario) REFERENCES USUARIO (cd_usuario)
);

CREATE TABLE itens_ordem_servico (
	nr_os INTEGER,
	cd_servico INTEGER,
	cd_situacao INTEGER,
	dt_atendimento DATE,
	ds_atendimento VARCHAR(100),
	PRIMARY KEY(nr_os, cd_servico),
	FOREIGN KEY (nr_os) REFERENCES ORDEM_SERVICO (nr_os),
	FOREIGN KEY (cd_servico) REFERENCES SERVICO (cd_servico),
	FOREIGN KEY (cd_situacao) REFERENCES SITUACAO (cd_situacao)
);

-- 2
INSERT INTO USUARIO VALUES (1, 'ANA', 'ANA@GMAIL.COM', '(47) 91111-1111');
INSERT INTO USUARIO VALUES (2, 'GABRIEL', 'GABRIEL@GMAIL.COM', '(47) 91234-5678');
INSERT INTO USUARIO VALUES (3, 'LUIZ', 'LUIZ@GMAIL.COM', '(47) 99999-9999');

INSERT INTO SERVICO VALUES (1, 'TROCA DE MONITOR DE VIDEO', 'TROCAR POR MONITOR MAIS RECENTE');
INSERT INTO SERVICO VALUES (2, 'INSTALAÇÃO DE EDITOR DE TEXTO', 'AGUARDANDAR ATUALIZAÇÃO DO WINDOWS');
INSERT INTO SERVICO VALUES (3, 'MANUTENÇÃO DE TECLADO', 'TROCAR AS TECLAS GASTAS');
INSERT INTO SERVICO VALUES (4, 'ATUALIZACAO DO WINDOWS', null);
INSERT INTO SERVICO VALUES (5, 'MANUTENÇÃO DA REDE DE WIFI', 'MODIFICAR A DISPOSIÇÃO DOS CABOS DE REDE');

INSERT INTO SITUACAO VALUES (1, 'AGUARDANDO MÃO DE OBRA');
INSERT INTO SITUACAO VALUES (2, 'SERVIÇO CONCLUÍDO');
INSERT INTO SITUACAO VALUES (3, 'AGUARDANDO HORÁRIO A SER MARCADO');
INSERT INTO SITUACAO VALUES (4, 'SERVIÇO EM ANDAMENTO');
INSERT INTO SITUACAO VALUES (5, 'AGUARDANDO PEÇA');

INSERT INTO ORDEM_SERVICO VALUES (1, 1, '2023-11-01', null);
INSERT INTO ORDEM_SERVICO VALUES (2, 2, '2023-11-30', 'BAIXA PRIORIDADE');
INSERT INTO ORDEM_SERVICO VALUES (3, 3, '2023-11-25', 'ALTA PRIORIDADE');
INSERT INTO ORDEM_SERVICO VALUES (4, 1, '2023-11-12', 'MÉDIA PRIORIDADE');
INSERT INTO ORDEM_SERVICO VALUES (5, 2, '2023-11-10', 'BAIXA PRIORIDADE');

INSERT INTO ITENS_ORDEM_SERVICO VALUES (1, 1, 3, '2023-11-08', 'ATENDIMENTO NÃO MARCADO');
INSERT INTO ITENS_ORDEM_SERVICO VALUES (1, 2, 5, '2023-12-01', 'ATENDIMENTO NÃO FINALIZADO POR FALTA DE PEÇA');
INSERT INTO ITENS_ORDEM_SERVICO VALUES (1, 3, 2, '2023-11-26', 'ATENDIMENTO FINALIZADO');

INSERT INTO ITENS_ORDEM_SERVICO VALUES (2, 2, 1, '2023-12-03', 'ATENDIMENTO NÃO FINALIZADO POR FALTA DE MÃO DE OBRA');
INSERT INTO ITENS_ORDEM_SERVICO VALUES (2, 3, 4, '2023-11-28', 'ATENDIMENTO NÃO FINALIZADO POR FALTA DE TEMPO');
INSERT INTO ITENS_ORDEM_SERVICO VALUES (2, 4, 3, '2023-11-22', 'ATENDIMENTO NÃO MARCADO');

INSERT INTO ITENS_ORDEM_SERVICO VALUES (3, 5, 5, '2023-11-11', 'ATENDIMENTO NÃO FINALIZADO POR FALTA DE PEÇA');
INSERT INTO ITENS_ORDEM_SERVICO VALUES (3, 1, 1, '2023-11-17', 'ATENDIMENTO NÃO FINALIZADO POR FALTA DE MÃO DE OBRA');
 
INSERT INTO ITENS_ORDEM_SERVICO VALUES (4, 2, 4, '2023-12-04', 'ATENDIMENTO NÃO FINALIZADO POR FALTA DE TEMPO');
INSERT INTO ITENS_ORDEM_SERVICO VALUES (4, 3, 2, '2023-12-04', 'ATENDIMENTO FINALIZADO');

INSERT INTO ITENS_ORDEM_SERVICO VALUES (5, 4, 2, '2023-11-30', 'ATENDIMENTO FINALIZADO');
INSERT INTO ITENS_ORDEM_SERVICO VALUES (5, 5, 2, '2023-12-02', 'ATENDIMENTO FINALIZADO');
 
-- 3
SELECT u.nm_usuario AS 'USUÁRIO', COUNT(os.cd_usuario) AS 'NÚMERO DA ORDEM DE SERVIÇO', os.dt_registro AS 'DATA DA ORDEM DE SERVIÇO'
FROM USUARIO u JOIN ORDEM_SERVICO os ON (u.cd_usuario = os.cd_usuario)
GROUP BY u.nm_usuario

-- 4 
SELECT u.nm_usuario AS 'USUÁRIO', os.nr_os AS 'NÚMERO DA ORDEM DE SERVIÇO', s.ds_servico AS 'DESCRIÇÃO DE SERVIÇO'
FROM ORDEM_SERVICO os JOIN USUARIO u ON (os.cd_usuario = u.cd_usuario) JOIN ITENS_ORDEM_SERVICO ios ON (ios.nr_os = os.nr_os) 
	 JOIN SERVICO s ON (s.cd_servico = ios.cd_servico)
WHERE os.dt_registro BETWEEN '2023-11-10' AND '2023-11-15'
ORDER BY u.nm_usuario
	
-- 5
SELECT os.nr_os AS 'NÚMERO DA ORDEM DE SERVIÇO', os.dt_registro AS 'DATA DA ORDEM DE SERVIÇO', s.ds_servico AS 'DESCRIÇÃO DE SERVIÇO'
FROM ORDEM_SERVICO os JOIN ITENS_ORDEM_SERVICO ios ON (os.nr_os = ios.nr_os) JOIN SERVICO s ON (ios.cd_servico = s.cd_servico)
WHERE ios.ds_atendimento <> 'CONCLUIDO'
	
-- 6
SELECT s.ds_servico AS 'DESCRIÇÃO DE SERVIÇO'
FROM SERVICO s JOIN ITENS_ORDEM_SERVICO ios ON (s.cd_servico = ios.cd_servico)
WHERE ios.dt_atendimento > '2023-11-30'